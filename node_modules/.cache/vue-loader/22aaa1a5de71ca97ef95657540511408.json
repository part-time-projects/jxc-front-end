{"remainingRequest":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\ideaworkspace\\jxc-front-end\\src\\views\\erp\\stock\\modules\\RubricPurInBillModal.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\ideaworkspace\\jxc-front-end\\src\\views\\erp\\stock\\modules\\RubricPurInBillModal.vue","mtime":1648374777647},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1648365135345},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\babel-loader\\lib\\index.js","mtime":1648365068269},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1648365135345},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\vue-loader\\lib\\index.js","mtime":1648364957239}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n\nimport pick from 'lodash.pick'\nimport { FormTypes,getRefPromise,VALIDATE_NO_PASSED, validateFormAndTables } from '@/utils/JEditableTableUtil'\nimport { JEditableTableMixin } from '@/mixins/JEditableTableMixin'\nimport JDate from '@/components/jeecg/JDate'\nimport JUpload from '@/components/jeecg/JUpload'\nimport JSelectUserByDep from '@/components/jeecgbiz/JSelectUserByDep'\nimport JDictSelectTag from \"@/components/dict/JDictSelectTag\"\nimport { putAction } from '@api/manage'\nimport { billModalMixin } from '../../mixins/billModalMixin'\nimport OnlCgreportSelectModal from '../../components/OnlCgreportSelectModal'\nimport EditableTableColumnsSetter from \"../../components/EditableTableColumnsSetter\";\nimport { getFormatDate } from '../../utils/util'\nimport { validateEntryNo } from '../../utils/editableTableValidate'\n\nexport default {\n  name: 'RubricPurInBillModal',\n  mixins: [JEditableTableMixin, billModalMixin],\n  components: {\n    EditableTableColumnsSetter,\n    JDate,\n    JUpload,\n    JSelectUserByDep,\n    JDictSelectTag,\n    OnlCgreportSelectModal\n  },\n\n  data() {\n    return {\n      width: '1200px',\n      moreStatus: false,\n\n      // 新增时子表默认添加几行空数据\n      addDefaultRowNum: 0,\n      refKeys: ['stkIoBillEntry', 'sourceStkIoBillEntry', ],\n      tableKeys:['stkIoBillEntry', ],\n      activeKey: 'stkIoBillEntry',\n\n      // 采购退货出库明细\n      stkIoBillEntryTable: {\n        loading: false,\n        dataSource: [],\n        selectedRowCount: 0,\n        settingColumns: [], //显示列设置\n        columns: [\n          {\n            title: '分录号',\n            key: 'entryNo',\n            type: FormTypes.inputNumber,\n            width:\"60px\",\n            disabled: true,\n          },\n          {\n            title: '源单类型',\n            key: 'sourceType',\n            type: FormTypes.hidden,\n            width:\"100px\",\n            disabled: true,\n          },\n          {\n            title: '源单分录id',\n            key: 'sourceEntryId',\n            type: FormTypes.hidden,\n            width:\"180px\",\n            disabled: true,\n          },\n          {\n            title: '源单分录号',\n            key: 'sourceEntryNo',\n            type: FormTypes.hidden,\n            width:\"180px\",\n            disabled: true,\n          },\n          {\n            title: '物料',\n            key: 'materialId',\n            type: FormTypes.sel_search,\n            dictCode:\"bas_material,name,id\",\n            width:\"200px\",\n            options:[],\n            disabled: true,\n          },\n          {\n            title: '计量单位',\n            key: 'unitId',\n            type: FormTypes.select,\n            dictCode:\"bas_measure_unit,name,id\",\n            width:\"100px\",\n            options:[],\n            disabled: true,\n          },\n          {\n            title: '入库数量',\n            key: 'qty',\n            type: FormTypes.inputNumber,\n            statistics: \"true\",\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            validateRules: [\n              { required: true, message: '${title}不能为空' },\n              { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\n              { handler: this.validateRubric},\n            ],\n          },\n          {\n            title: '入库成本',\n            key: 'cost',\n            type: FormTypes.inputNumber,\n            statistics: \"true\",\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            validateRules: [\n              { required: true, message: '${title}不能为空' },\n              { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\n              { handler: this.validateRubric},\n            ],\n          },\n          {\n            title: '成本含税',\n            key: 'isInclTax',\n            type: FormTypes.select,\n            dictCode:\"yn\",\n            width:\"80px\",\n            options:[],\n            disabled: true,\n          },\n          {\n            title: '仓库',\n            key: 'warehouseId',\n            type: FormTypes.select,\n            dictCode:\"bas_warehouse,name,id\",\n            width:\"150px\",\n            options:[],\n            disabled: true,\n          },\n          {\n            title: '批次号',\n            key: 'batchNo',\n            type: FormTypes.input,\n            width:\"200px\",\n            disabled: true,\n          },\n          {\n            title: '结算数量',\n            key: 'settleQty',\n            type: FormTypes.inputNumber,\n            statistics: \"true\",\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            validateRules: [\n              { required: true, message: '${title}不能为空' },\n              { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\n              { handler: this.validateRubric},\n            ],\n          },\n          {\n            title: '含税单价',\n            key: 'settlePrice',\n            type: FormTypes.inputNumber,\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '税率%',\n            key: 'taxRate',\n            type: FormTypes.inputNumber,\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '税额',\n            key: 'tax',\n            type: FormTypes.inputNumber,\n            statistics: \"true\",\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            validateRules: [\n              { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\n              { handler: this.validateRubric},\n            ],\n          },\n          {\n            title: '折让金额',\n            key: 'discountAmt',\n            type: FormTypes.inputNumber,\n            statistics: \"true\",\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            validateRules: [\n              { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\n              { handler: this.validateRubric},\n            ],\n          },\n          {\n            title: '折让税额',\n            key: 'discountTax',\n            type: FormTypes.inputNumber,\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            validateRules: [\n              { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\n              { handler: this.validateRubric},\n            ],\n          },\n          {\n            title: '结算金额',\n            key: 'settleAmt',\n            type: FormTypes.inputNumber,\n            statistics: \"true\",\n            width:\"120px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            validateRules: [\n              { required: true, message: '${title}不能为空' },\n              { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\n              { handler: this.validateRubric},\n            ],\n          },\n          {\n            title: '已开票数量',\n            key: 'invoicedQty',\n            type: FormTypes.input,\n            statistics: \"true\",\n            width:\"120px\",\n            defaultValue: '',\n            disabled:true,\n          },\n          {\n            title: '已开票金额',\n            key: 'invoicedAmt',\n            type: FormTypes.input,\n            statistics: \"true\",\n            width:\"120px\",\n            defaultValue: '',\n            disabled:true,\n          },\n          {\n            title: '备注',\n            key: 'remark',\n            type: FormTypes.input,\n            width:\"200px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '备注2',\n            key: 'remark2',\n            type: FormTypes.input,\n            width:\"200px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '备注3',\n            key: 'remark3',\n            type: FormTypes.input,\n            width:\"200px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '',\n            key: 'flag',\n            type: FormTypes.hidden,\n            width:\"1px\",\n            placeholder: '',\n            defaultValue: '',\n          },\n        ],\n      },\n\n      //原采购入库单\n      sourceStkIoBillEntryTable: {\n        loading: false,\n        dataSource: [],\n        selectedRowCount: 0,\n        disabledRows:{},\n      },\n      validatorRules: {\n        stockIoType: {rules: [\n          ]},\n        billNo: {rules: [\n            {required: true, message: '请输入单据编号!'},\n          ]},\n        billDate: {rules: [\n            {required: true, message: '请输入单据日期!'},\n          ]},\n        sourceType: {rules: [\n          ]},\n        sourceNo: {rules: [\n            {required: true, message: '请选择采购入库单!'},]},\n        clerkId: {rules: [\n          ]},\n        handlerId: {rules: [\n          ]},\n        hasRp: {rules: [\n          ]},\n        isRubric: {rules: [\n          ]},\n        isSameSettle: {rules: [\n          ]},\n        supplierId: {rules: [\n          ]},\n        customerId: {rules: [\n          ]},\n        attachment: {rules: [\n          ]},\n        remark: {rules: [\n          ]},\n        billProcStatus: {rules: [\n          ]},\n        approverId: {rules: [\n          ]},\n        flowId: {rules: [\n          ]},\n        isApproved: {rules: [\n          ]},\n        effectiveTime: {rules: [\n          ]},\n        isVoided: {rules: [\n          ]},\n        isClosed: {rules: [\n          ]},\n        sysOrgCode: {rules: [\n          ]},\n        createBy: {rules: [\n          ]},\n        createTime: {rules: [\n          ]},\n        updateBy: {rules: [\n          ]},\n        updateTime: {rules: [\n          ]},\n      },\n\n      url: {\n        add: \"/stock/stkIoBill/add\",\n        edit: \"/stock/stkIoBill/edit\",\n        approve: \"/stock/stkIoBill/approve\",\n        stkIoBillEntry: {\n          list: '/stock/stkIoBill/queryEntryByMainId'\n        },\n      }\n    }\n  },\n\n  methods: {\n    getAllTable() {\n      let values = this.tableKeys.map(key => getRefPromise(this, key))\n      return Promise.all(values)\n    },\n\n    addInit() {\n      //采购入库（红字）\n      this.model.stockIoType = '1011'\n      this.model.isRubric = 1\n      //是否有往来\n      this.model.hasRp = 1\n      //结算是否同入库（或取自系统参数）\n      this.model.isSameSettle = 0\n      //源单类型：采购入库\n      this.model.sourceType = 'stk_io_bill..101'\n      //处理状态：编辑中\n      this.model.billProcStatus = '12'\n\n\n      // 请求后台的填值规则接口地址\n      const url = '/sys/fillRule/executeRuleByCode/'\n      const ruleCode = 'stock_io_bill_no'\n      const that = this\n      putAction(url + ruleCode, {}).then(res => {\n        // 执行成功，获取返回的值，并赋到页面上\n        if (res.success) {\n          that.model.billNo = res.result;\n          that.$nextTick( ()=>that.form.setFieldsValue({'billNo':res.result, 'billDate':getFormatDate()}) )\n        }\n      })\n    },\n\n    /** 调用完edit()方法之后会自动调用此方法 */\n    editAfter() {\n      const that = this;\n      //sourceStkIoBillEntry未在tableKeys中\n      this.$nextTick( ()=>that.$refs.sourceStkIoBillEntry.initialize() );\n\n      if (this.action === 'add') {\n        this.addInit();\n        this.activeKey = 'sourceStkIoBillEntry';\n      } else {\n        this.activeKey = 'stkIoBillEntry';\n      }\n\n      let fieldval = pick(this.model,'billNo','billDate','sourceType','sourceNo','clerkId','handlerId',\n        'isRubric','isSameSettle','supplierId','attachment','remark','billProcStatus','approverId','flowId',\n        'isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime')\n      this.$nextTick(() => {\n        that.form.setFieldsValue(fieldval)\n        that.onIsSameSettleChange(this.model.isSameSettle.toString())\n      })\n      // 加载子表数据\n      if (this.model.id) {\n        let params = { id: this.model.id }\n        this.requestSubTableData(this.url.stkIoBillEntry.list, params, this.stkIoBillEntryTable, loadSecondSubTableData);\n        function loadSecondSubTableData(){\n          let params = { id: that.model.sourceId }\n          that.requestSubTableData(that.url.stkIoBillEntry.list, params, that.sourceStkIoBillEntryTable, that.refreshDisabledRows);\n        }\n      }\n    },\n\n    /** 整理成formData */\n    classifyIntoFormData(allValues) {\n      let main = Object.assign(this.model, allValues.formValue)\n\n      return {\n        ...main, // 展开source.dataSource =\n        stkIoBillEntryList: allValues.tablesValue[0].values,\n      }\n    },\n    validateError(msg){\n      this.$message.error(msg)\n    },\n    popupCallback(row){\n      this.form.setFieldsValue(pick(row,'billNo','billDate','sourceType','sourceNo','clerkId','handlerId','isRubric','isSameSettle','supplierId','attachment','remark','billProcStatus','approverId','flowId','isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime'))\n    },\n\n    onIsSameSettleChange(val) {\n      this.$refs.stkIoBillEntry.columns.forEach(function (item, i, array ) {\n        if (item.key === \"settleQty\" || item.key === \"settleAmt\") {\n          item.disabled = (val === '1');\n        }\n      });\n\n      if (val === '1') {\n        let { error, values } = this.$refs.stkIoBillEntry.getValuesSync({ validate: false})\n        for (let v of values) {\n          this.$refs.stkIoBillEntry.setValues([{rowKey: v.id, values: {settleQty: v.qty, settleAmt:v.cost}}]);\n        }\n      }\n    },\n\n    //单元值改变一个字符就触发一次\n    onValueChange(event) {\n      const { type, row, column, value, target } = event\n\n      //联动\n      //触发：入库数量, 联动列结算数量\n      if (column.key === 'qty') {\n        if (this.form.getFieldValue(\"isSameSettle\") === '1') {\n          target.setValues([{rowKey: row.id, values: {settleQty: value}}]);\n        }\n      }\n      //触发：入库成本, 联动：结算金额\n      else if (column.key === 'cost') {\n        if (this.form.getFieldValue(\"isSameSettle\") === '1') {\n          target.setValues([{rowKey: row.id, values: {settleAmt: value}}]);\n        }\n      }\n    },\n\n    handleSourceSelect() {\n      let queryParams = {};\n      queryParams['supplier_id'] = this.form.getFieldValue('supplierId');\n      this.$refs.selectModal.initQueryParams(queryParams);\n      this.$refs.selectModal.visible = true;\n    },\n    handleSourceSelectCallback(selectedRows){\n      if ( this.model.sourceId === selectedRows[0]['id']) return;\n\n      this.model.sourceId = selectedRows[0]['id'];\n      this.form.setFieldsValue({sourceNo: selectedRows[0]['bill_no'],\n        supplierId: selectedRows[0]['supplier_id']});\n\n      // 加载子表数据\n      let params = { id: this.model.sourceId }\n      this.requestSubTableData(this.url.stkIoBillEntry.list, params, this.sourceStkIoBillEntryTable, this.refreshDisabledRows);\n    },\n\n    handleAddEntry(){\n      let source = this.$refs.sourceStkIoBillEntry,\n          target = this.$refs.stkIoBillEntry;\n\n      let { values } = source.getValuesSync({ validate: false, rowIds: source.selectedRowIds});\n      for(let v of values) {\n        let row = pick(v, 'entryNo','materialId','unitId','isInclTax','warehouseId','batchNo','settlePrice','taxRate');\n        row.sourceType = 'stk_io_bill.stk_io_bill_entry.101';\n        row.sourceEntryId = v.id;\n        row.sourceEntryNo = this.form.getFieldValue(\"sourceNo\") + '.' + v.entryNo;\n        row.qty = -v.qty;\n        row.cost = -v.cost;\n        row.settleQty = -v.settleQty;\n        row.tax = -v.tax;\n        row.discountAmt = -v.discountAmt\n        row.discountTax = -v.discountTax\n        row.settleAmt = -v.settleAmt;\n        target.add();\n        let rowId = target.rows[target.rows.length - 1].id;\n        target.setValues([{rowKey: rowId, values: row}]);\n      }\n      this.refreshDisabledRows();\n    },\n\n    handleRemoveEntry(){\n      this.$refs.stkIoBillEntry.removeSelectedRows();\n      this.refreshDisabledRows();\n    },\n\n    refreshDisabledRows(){\n      let that = this;\n      let entryNos = [];\n      let { values } = that.$refs.stkIoBillEntry.getValuesSync({ validate: false});\n      for(let v of values) {\n        entryNos.push(Number(v.entryNo));\n      }\n      that.sourceStkIoBillEntryTable.disabledRows = entryNos.length===0 ? {} : {entryNo:entryNos};\n      //disabledRowIds不初始会保留前面的数据，导致与disabledRows不一致！\n      that.$refs.sourceStkIoBillEntry.disabledRowIds = [];\n      //使新的disabledRows生效\n      let dataSource = [...that.sourceStkIoBillEntryTable.dataSource];\n      that.sourceStkIoBillEntryTable.dataSource = dataSource;\n    },\n\n    validateRubric(type, value, row, column, callback, target) {\n      if (type !== 'blur') {\n        callback();\n        return;\n      }\n\n      let { values } = target.getValuesSync({ validate: false, rowIds: [row.id]});\n      let rubric = Number(values[0][column.key]);\n      if (isNaN(rubric)) {\n        callback();\n        return;\n      }\n\n      let sourceEntryId = values[0].sourceEntryId;\n      let rows = this.sourceStkIoBillEntryTable.dataSource.filter(row => row.id === sourceEntryId);\n      let blue = rows[0][column.key]\n      if (isNaN(blue)) {\n        callback();\n        return;\n      }\n\n      if (-rubric > blue) {\n        callback(false, '不能超出入库！');\n        return;\n      }\n\n      callback(true); //true：通过验证\n    },\n\n  },\n\n}\n",{"version":3,"sources":["RubricPurInBillModal.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA","file":"RubricPurInBillModal.vue","sourceRoot":"src/views/erp/stock/modules","sourcesContent":["<template>\r\n  <j-modal\r\n    :title=\"'采购退货出库 - ' + title\"\r\n    :width=\"width\"\r\n    :visible=\"visible\"\r\n    :confirmLoading=\"confirmLoading\"\r\n    :maskClosable=\"false\"\r\n    :keyboard=\"false\"\r\n    :forceRender=\"true\"\r\n    switchFullscreen\r\n    @cancel=\"handleCancel\">\r\n\r\n    <template slot=\"footer\">\r\n      <a-button v-if=\"action!=='detail'\" key=\"cancel\" @click=\"handleCancel\">取消</a-button>\r\n      <a-button v-if=\"!readOnly\" key=\"save\"   @click=\"handleSave\" type=\"primary\" :loading=\"confirmLoading\">保存</a-button>\r\n      <a-button v-if=\"!readOnly\" key=\"submit\" @click=\"handleSubmit\" type=\"primary\" :loading=\"confirmLoading\">提交</a-button>\r\n      <a-button v-if=\"action==='detail'\"  key=\"close\"  @click=\"handleCancel\" type=\"primary\">关闭</a-button>\r\n      <a-button v-if=\"action==='approve'\"  key=\"approved\"  @click=\"handleApproved\" type=\"primary\">审核通过</a-button>\r\n    </template>\r\n\r\n    <a-spin :spinning=\"confirmLoading\">\r\n      <!-- 主表单区域 -->\r\n      <a-form :form=\"form\">\r\n        <a-row>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"处理状态\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['billProcStatus', validatorRules.billProcStatus]\" :trigger-change=\"true\" dictCode=\"x_bill_proc_status\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a-form-item label=\"是否通过\" :labelCol=\"spans.labelCol6\" :wrapperCol=\"spans.wrapperCol6\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['isApproved', validatorRules.isApproved]\" :trigger-change=\"true\" dictCode=\"yn\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a-form-item label=\"是否关闭\" :labelCol=\"spans.labelCol6\" :wrapperCol=\"spans.wrapperCol6\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['isClosed', validatorRules.isClosed]\" :trigger-change=\"true\" dictCode=\"yn\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a-form-item label=\"是否作废\" :labelCol=\"spans.labelCol6\" :wrapperCol=\"spans.wrapperCol6\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['isVoided', validatorRules.isVoided]\" :trigger-change=\"true\" dictCode=\"yn\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a @click=\"()=> this.moreStatus = !this.moreStatus\" style=\"float: right; margin-top: 10px\">\r\n              {{ moreStatus ? '收起' : '展开' }}\r\n              <a-icon :type=\"moreStatus ? 'up' : 'down'\"/>\r\n            </a>\r\n          </a-col>\r\n        </a-row>\r\n        <a-row v-show=\"moreStatus\">\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"创建时间\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"true\" v-decorator=\"[ 'createTime', validatorRules.createTime]\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"创建人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['createBy', validatorRules.createBy]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"创建部门\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['sysOrgCode', validatorRules.sysOrgCode]\" :trigger-change=\"true\" dictCode=\"sys_depart,depart_name,org_code\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"生效时间\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"true\" v-decorator=\"[ 'effectiveTime', validatorRules.effectiveTime]\" :showTime=\"true\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"审核人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['approverId', validatorRules.approverId]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"流程\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <a-input :readOnly=\"true\" v-decorator=\"[ 'flowId', validatorRules.flowId]\" ></a-input>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"修改时间\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"true\" v-decorator=\"[ 'updateTime', validatorRules.updateTime]\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"修改人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['updateBy', validatorRules.updateBy]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"是否红字\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['isRubric', validatorRules.isRubric]\" :trigger-change=\"true\" dictCode=\"yn\" />\r\n            </a-form-item>\r\n          </a-col>\r\n        </a-row>\r\n        <a-row>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"单据编号\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <a-input :readOnly=\"true\" v-decorator=\"[ 'billNo', validatorRules.billNo]\" ></a-input>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"单据日期\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"readOnly\" placeholder=\"请选择单据日期\" v-decorator=\"[ 'billDate', validatorRules.billDate]\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item  label=\"制单人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled  type=\"list\" v-decorator=\"['createBy', validatorRules.createBy]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"业务员\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-select-user-by-dep :disabled=\"readOnly\" v-decorator=\"['clerkId', validatorRules.clerkId]\" :trigger-change=\"true\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <!--业务员有供应商分管范围，所以先输入业务员，再选择供应商-->\r\n            <a-form-item label=\"供应商\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag :disabled=\"readOnly\" type=\"list\"\r\n                                 v-decorator=\"['supplierId', validatorRules.supplierId]\"  :trigger-change=\"true\"\r\n                                 dictCode=\"bas_supplier,name,id\" placeholder=\"请选择供应商\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"出库经办\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-select-user-by-dep :disabled=\"readOnly\" v-decorator=\"['handlerId', validatorRules.handlerId]\" :trigger-change=\"true\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col v-show=\"false\" :span=\"8\">\r\n            <a-form-item label=\"源单类型\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['sourceType', validatorRules.sourceType]\" :trigger-change=\"true\" dictCode=\"x_bill_type\" placeholder=\"请选择源单类型\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"采购入库单\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <a-input :readOnly=\"true\" v-decorator=\"[ 'sourceNo', validatorRules.sourceNo]\" placeholder=\"请选择源单\">\r\n                <a-icon @click=\"handleSourceSelect\" slot=\"addonAfter\" type=\"ellipsis\" />\r\n              </a-input>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"结算数量和金额是否等于入库\" :labelCol=\"{span:15}\" :wrapperCol=\"{span:9}\">\r\n              <j-dict-select-tag type=\"list\" :disabled=\"readOnly\" :trigger-change=\"true\" dictCode=\"yn\"\r\n                                 @change=\"onIsSameSettleChange\" v-decorator=\"['isSameSettle', validatorRules.isSameSettle]\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n        </a-row>\r\n        <a-row>\r\n          <a-col :span=\"24\">\r\n            <a-form-item label=\"备注\" :labelCol=\"spans.labelCol1\" :wrapperCol=\"spans.wrapperCol1\">\r\n              <a-textarea :readOnly=\"readOnly\" v-decorator=\"[ 'remark', validatorRules.remark]\" placeholder=\"请输入备注\" rows=\"1\" autoSize></a-textarea>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"24\">\r\n            <a-form-item label=\"附件\" :labelCol=\"spans.labelCol1\" :wrapperCol=\"spans.wrapperCol1\">\r\n              <j-upload :disabled=\"readOnly\" v-decorator=\"['attachment', validatorRules.attachment]\" :trigger-change=\"true\"></j-upload>\r\n            </a-form-item>\r\n          </a-col>\r\n        </a-row>\r\n      </a-form>\r\n\r\n      <!-- 子表单区域 -->\r\n      <a-tabs v-model=\"activeKey\" @change=\"handleChangeTabs\">\r\n        <a-tab-pane tab=\"原入库明细\" :key=\"refKeys[1]\" :forceRender=\"true\">\r\n          <div v-if=\"!readOnly\" class=\"table-operator\">\r\n            <a-button :disabled=\"sourceStkIoBillEntryTable.selectedRowCount===0\"\r\n                      @click=\"handleAddEntry\" type=\"primary\" >添加<a-icon type=\"right\" /></a-button>\r\n          </div>\r\n          <j-editable-table\r\n            :disabled=\"true\"\r\n            :ref=\"refKeys[1]\"\r\n            :loading=\"sourceStkIoBillEntryTable.loading\"\r\n            :columns=\"stkIoBillEntryTable.columns\"\r\n            :dataSource=\"sourceStkIoBillEntryTable.dataSource\"\r\n            :disabledRows=\"sourceStkIoBillEntryTable.disabledRows\"\r\n            :maxHeight=\"300\"\r\n            :rowNumber=\"false\"\r\n            :rowSelection=\"!readOnly\"\r\n            :actionButton=\"false\"\r\n            @selectRowChange=\"(selectedRowIds)=>sourceStkIoBillEntryTable.selectedRowCount=selectedRowIds.length\"\r\n          />\r\n        </a-tab-pane>\r\n\r\n        <a-tab-pane tab=\"退货出库明细\" :key=\"refKeys[0]\" :forceRender=\"true\">\r\n          <div v-if=\"!readOnly\" class=\"table-operator\">\r\n            <a-button :disabled=\"stkIoBillEntryTable.selectedRowCount===0\"\r\n                      @click=\"handleRemoveEntry\" type=\"primary\" icon=\"left\">移除</a-button>\r\n          </div>\r\n          <j-editable-table\r\n            :disabled=\"readOnly\"\r\n            :ref=\"refKeys[0]\"\r\n            :loading=\"stkIoBillEntryTable.loading\"\r\n            :columns=\"stkIoBillEntryTable.columns\"\r\n            :dataSource=\"stkIoBillEntryTable.dataSource\"\r\n            :maxHeight=\"300\"\r\n            :rowNumber=\"false\"\r\n            :rowSelection=\"!readOnly\"\r\n            :actionButton=\"false\"\r\n            @selectRowChange=\"(selectedRowIds)=>stkIoBillEntryTable.selectedRowCount=selectedRowIds.length\"\r\n            @valueChange=\"onValueChange\"\r\n          />\r\n        </a-tab-pane>\r\n\r\n        <template slot=\"tabBarExtraContent\">\r\n          <editable-table-columns-setter :columns=\"stkIoBillEntryTable.columns\" tableName=\"stkIoBillEntryTable\" />\r\n        </template>\r\n      </a-tabs>\r\n\r\n      <onl-cgreport-select-modal\r\n        ref=\"selectModal\"\r\n        title=\"选择采购入库单\"\r\n        reportId=\"1260569956423487489\"\r\n        :width=\"1100\"\r\n        :multiSelectable=\"false\"\r\n        @callback=\"handleSourceSelectCallback\"\r\n      />\r\n\r\n    </a-spin>\r\n  </j-modal>\r\n</template>\r\n\r\n<script>\r\n\r\n  import pick from 'lodash.pick'\r\n  import { FormTypes,getRefPromise,VALIDATE_NO_PASSED, validateFormAndTables } from '@/utils/JEditableTableUtil'\r\n  import { JEditableTableMixin } from '@/mixins/JEditableTableMixin'\r\n  import JDate from '@/components/jeecg/JDate'\r\n  import JUpload from '@/components/jeecg/JUpload'\r\n  import JSelectUserByDep from '@/components/jeecgbiz/JSelectUserByDep'\r\n  import JDictSelectTag from \"@/components/dict/JDictSelectTag\"\r\n  import { putAction } from '@api/manage'\r\n  import { billModalMixin } from '../../mixins/billModalMixin'\r\n  import OnlCgreportSelectModal from '../../components/OnlCgreportSelectModal'\r\n  import EditableTableColumnsSetter from \"../../components/EditableTableColumnsSetter\";\r\n  import { getFormatDate } from '../../utils/util'\r\n  import { validateEntryNo } from '../../utils/editableTableValidate'\r\n\r\n  export default {\r\n    name: 'RubricPurInBillModal',\r\n    mixins: [JEditableTableMixin, billModalMixin],\r\n    components: {\r\n      EditableTableColumnsSetter,\r\n      JDate,\r\n      JUpload,\r\n      JSelectUserByDep,\r\n      JDictSelectTag,\r\n      OnlCgreportSelectModal\r\n    },\r\n\r\n    data() {\r\n      return {\r\n        width: '1200px',\r\n        moreStatus: false,\r\n\r\n        // 新增时子表默认添加几行空数据\r\n        addDefaultRowNum: 0,\r\n        refKeys: ['stkIoBillEntry', 'sourceStkIoBillEntry', ],\r\n        tableKeys:['stkIoBillEntry', ],\r\n        activeKey: 'stkIoBillEntry',\r\n\r\n        // 采购退货出库明细\r\n        stkIoBillEntryTable: {\r\n          loading: false,\r\n          dataSource: [],\r\n          selectedRowCount: 0,\r\n          settingColumns: [], //显示列设置\r\n          columns: [\r\n            {\r\n              title: '分录号',\r\n              key: 'entryNo',\r\n              type: FormTypes.inputNumber,\r\n              width:\"60px\",\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '源单类型',\r\n              key: 'sourceType',\r\n              type: FormTypes.hidden,\r\n              width:\"100px\",\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '源单分录id',\r\n              key: 'sourceEntryId',\r\n              type: FormTypes.hidden,\r\n              width:\"180px\",\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '源单分录号',\r\n              key: 'sourceEntryNo',\r\n              type: FormTypes.hidden,\r\n              width:\"180px\",\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '物料',\r\n              key: 'materialId',\r\n              type: FormTypes.sel_search,\r\n              dictCode:\"bas_material,name,id\",\r\n              width:\"200px\",\r\n              options:[],\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '计量单位',\r\n              key: 'unitId',\r\n              type: FormTypes.select,\r\n              dictCode:\"bas_measure_unit,name,id\",\r\n              width:\"100px\",\r\n              options:[],\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '入库数量',\r\n              key: 'qty',\r\n              type: FormTypes.inputNumber,\r\n              statistics: \"true\",\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              validateRules: [\r\n                { required: true, message: '${title}不能为空' },\r\n                { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\r\n                { handler: this.validateRubric},\r\n              ],\r\n            },\r\n            {\r\n              title: '入库成本',\r\n              key: 'cost',\r\n              type: FormTypes.inputNumber,\r\n              statistics: \"true\",\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              validateRules: [\r\n                { required: true, message: '${title}不能为空' },\r\n                { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\r\n                { handler: this.validateRubric},\r\n              ],\r\n            },\r\n            {\r\n              title: '成本含税',\r\n              key: 'isInclTax',\r\n              type: FormTypes.select,\r\n              dictCode:\"yn\",\r\n              width:\"80px\",\r\n              options:[],\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '仓库',\r\n              key: 'warehouseId',\r\n              type: FormTypes.select,\r\n              dictCode:\"bas_warehouse,name,id\",\r\n              width:\"150px\",\r\n              options:[],\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '批次号',\r\n              key: 'batchNo',\r\n              type: FormTypes.input,\r\n              width:\"200px\",\r\n              disabled: true,\r\n            },\r\n            {\r\n              title: '结算数量',\r\n              key: 'settleQty',\r\n              type: FormTypes.inputNumber,\r\n              statistics: \"true\",\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              validateRules: [\r\n                { required: true, message: '${title}不能为空' },\r\n                { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\r\n                { handler: this.validateRubric},\r\n              ],\r\n            },\r\n            {\r\n              title: '含税单价',\r\n              key: 'settlePrice',\r\n              type: FormTypes.inputNumber,\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '税率%',\r\n              key: 'taxRate',\r\n              type: FormTypes.inputNumber,\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '税额',\r\n              key: 'tax',\r\n              type: FormTypes.inputNumber,\r\n              statistics: \"true\",\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              validateRules: [\r\n                { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\r\n                { handler: this.validateRubric},\r\n              ],\r\n            },\r\n            {\r\n              title: '折让金额',\r\n              key: 'discountAmt',\r\n              type: FormTypes.inputNumber,\r\n              statistics: \"true\",\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              validateRules: [\r\n                { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\r\n                { handler: this.validateRubric},\r\n              ],\r\n            },\r\n            {\r\n              title: '折让税额',\r\n              key: 'discountTax',\r\n              type: FormTypes.inputNumber,\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              validateRules: [\r\n                { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\r\n                { handler: this.validateRubric},\r\n              ],\r\n            },\r\n            {\r\n              title: '结算金额',\r\n              key: 'settleAmt',\r\n              type: FormTypes.inputNumber,\r\n              statistics: \"true\",\r\n              width:\"120px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              validateRules: [\r\n                { required: true, message: '${title}不能为空' },\r\n                { pattern: /^((-\\d+(\\.\\d+)?)|(0+(\\.0+)?))$/, message: '请输入0或负数!' },\r\n                { handler: this.validateRubric},\r\n              ],\r\n            },\r\n            {\r\n              title: '已开票数量',\r\n              key: 'invoicedQty',\r\n              type: FormTypes.input,\r\n              statistics: \"true\",\r\n              width:\"120px\",\r\n              defaultValue: '',\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '已开票金额',\r\n              key: 'invoicedAmt',\r\n              type: FormTypes.input,\r\n              statistics: \"true\",\r\n              width:\"120px\",\r\n              defaultValue: '',\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '备注',\r\n              key: 'remark',\r\n              type: FormTypes.input,\r\n              width:\"200px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '备注2',\r\n              key: 'remark2',\r\n              type: FormTypes.input,\r\n              width:\"200px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '备注3',\r\n              key: 'remark3',\r\n              type: FormTypes.input,\r\n              width:\"200px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '',\r\n              key: 'flag',\r\n              type: FormTypes.hidden,\r\n              width:\"1px\",\r\n              placeholder: '',\r\n              defaultValue: '',\r\n            },\r\n          ],\r\n        },\r\n\r\n        //原采购入库单\r\n        sourceStkIoBillEntryTable: {\r\n          loading: false,\r\n          dataSource: [],\r\n          selectedRowCount: 0,\r\n          disabledRows:{},\r\n        },\r\n        validatorRules: {\r\n          stockIoType: {rules: [\r\n            ]},\r\n          billNo: {rules: [\r\n              {required: true, message: '请输入单据编号!'},\r\n            ]},\r\n          billDate: {rules: [\r\n              {required: true, message: '请输入单据日期!'},\r\n            ]},\r\n          sourceType: {rules: [\r\n            ]},\r\n          sourceNo: {rules: [\r\n              {required: true, message: '请选择采购入库单!'},]},\r\n          clerkId: {rules: [\r\n            ]},\r\n          handlerId: {rules: [\r\n            ]},\r\n          hasRp: {rules: [\r\n            ]},\r\n          isRubric: {rules: [\r\n            ]},\r\n          isSameSettle: {rules: [\r\n            ]},\r\n          supplierId: {rules: [\r\n            ]},\r\n          customerId: {rules: [\r\n            ]},\r\n          attachment: {rules: [\r\n            ]},\r\n          remark: {rules: [\r\n            ]},\r\n          billProcStatus: {rules: [\r\n            ]},\r\n          approverId: {rules: [\r\n            ]},\r\n          flowId: {rules: [\r\n            ]},\r\n          isApproved: {rules: [\r\n            ]},\r\n          effectiveTime: {rules: [\r\n            ]},\r\n          isVoided: {rules: [\r\n            ]},\r\n          isClosed: {rules: [\r\n            ]},\r\n          sysOrgCode: {rules: [\r\n            ]},\r\n          createBy: {rules: [\r\n            ]},\r\n          createTime: {rules: [\r\n            ]},\r\n          updateBy: {rules: [\r\n            ]},\r\n          updateTime: {rules: [\r\n            ]},\r\n        },\r\n\r\n        url: {\r\n          add: \"/stock/stkIoBill/add\",\r\n          edit: \"/stock/stkIoBill/edit\",\r\n          approve: \"/stock/stkIoBill/approve\",\r\n          stkIoBillEntry: {\r\n            list: '/stock/stkIoBill/queryEntryByMainId'\r\n          },\r\n        }\r\n      }\r\n    },\r\n\r\n    methods: {\r\n      getAllTable() {\r\n        let values = this.tableKeys.map(key => getRefPromise(this, key))\r\n        return Promise.all(values)\r\n      },\r\n\r\n      addInit() {\r\n        //采购入库（红字）\r\n        this.model.stockIoType = '1011'\r\n        this.model.isRubric = 1\r\n        //是否有往来\r\n        this.model.hasRp = 1\r\n        //结算是否同入库（或取自系统参数）\r\n        this.model.isSameSettle = 0\r\n        //源单类型：采购入库\r\n        this.model.sourceType = 'stk_io_bill..101'\r\n        //处理状态：编辑中\r\n        this.model.billProcStatus = '12'\r\n\r\n\r\n        // 请求后台的填值规则接口地址\r\n        const url = '/sys/fillRule/executeRuleByCode/'\r\n        const ruleCode = 'stock_io_bill_no'\r\n        const that = this\r\n        putAction(url + ruleCode, {}).then(res => {\r\n          // 执行成功，获取返回的值，并赋到页面上\r\n          if (res.success) {\r\n            that.model.billNo = res.result;\r\n            that.$nextTick( ()=>that.form.setFieldsValue({'billNo':res.result, 'billDate':getFormatDate()}) )\r\n          }\r\n        })\r\n      },\r\n\r\n      /** 调用完edit()方法之后会自动调用此方法 */\r\n      editAfter() {\r\n        const that = this;\r\n        //sourceStkIoBillEntry未在tableKeys中\r\n        this.$nextTick( ()=>that.$refs.sourceStkIoBillEntry.initialize() );\r\n\r\n        if (this.action === 'add') {\r\n          this.addInit();\r\n          this.activeKey = 'sourceStkIoBillEntry';\r\n        } else {\r\n          this.activeKey = 'stkIoBillEntry';\r\n        }\r\n\r\n        let fieldval = pick(this.model,'billNo','billDate','sourceType','sourceNo','clerkId','handlerId',\r\n          'isRubric','isSameSettle','supplierId','attachment','remark','billProcStatus','approverId','flowId',\r\n          'isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime')\r\n        this.$nextTick(() => {\r\n          that.form.setFieldsValue(fieldval)\r\n          that.onIsSameSettleChange(this.model.isSameSettle.toString())\r\n        })\r\n        // 加载子表数据\r\n        if (this.model.id) {\r\n          let params = { id: this.model.id }\r\n          this.requestSubTableData(this.url.stkIoBillEntry.list, params, this.stkIoBillEntryTable, loadSecondSubTableData);\r\n          function loadSecondSubTableData(){\r\n            let params = { id: that.model.sourceId }\r\n            that.requestSubTableData(that.url.stkIoBillEntry.list, params, that.sourceStkIoBillEntryTable, that.refreshDisabledRows);\r\n          }\r\n        }\r\n      },\r\n\r\n      /** 整理成formData */\r\n      classifyIntoFormData(allValues) {\r\n        let main = Object.assign(this.model, allValues.formValue)\r\n\r\n        return {\r\n          ...main, // 展开source.dataSource =\r\n          stkIoBillEntryList: allValues.tablesValue[0].values,\r\n        }\r\n      },\r\n      validateError(msg){\r\n        this.$message.error(msg)\r\n      },\r\n      popupCallback(row){\r\n        this.form.setFieldsValue(pick(row,'billNo','billDate','sourceType','sourceNo','clerkId','handlerId','isRubric','isSameSettle','supplierId','attachment','remark','billProcStatus','approverId','flowId','isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime'))\r\n      },\r\n\r\n      onIsSameSettleChange(val) {\r\n        this.$refs.stkIoBillEntry.columns.forEach(function (item, i, array ) {\r\n          if (item.key === \"settleQty\" || item.key === \"settleAmt\") {\r\n            item.disabled = (val === '1');\r\n          }\r\n        });\r\n\r\n        if (val === '1') {\r\n          let { error, values } = this.$refs.stkIoBillEntry.getValuesSync({ validate: false})\r\n          for (let v of values) {\r\n            this.$refs.stkIoBillEntry.setValues([{rowKey: v.id, values: {settleQty: v.qty, settleAmt:v.cost}}]);\r\n          }\r\n        }\r\n      },\r\n\r\n      //单元值改变一个字符就触发一次\r\n      onValueChange(event) {\r\n        const { type, row, column, value, target } = event\r\n\r\n        //联动\r\n        //触发：入库数量, 联动列结算数量\r\n        if (column.key === 'qty') {\r\n          if (this.form.getFieldValue(\"isSameSettle\") === '1') {\r\n            target.setValues([{rowKey: row.id, values: {settleQty: value}}]);\r\n          }\r\n        }\r\n        //触发：入库成本, 联动：结算金额\r\n        else if (column.key === 'cost') {\r\n          if (this.form.getFieldValue(\"isSameSettle\") === '1') {\r\n            target.setValues([{rowKey: row.id, values: {settleAmt: value}}]);\r\n          }\r\n        }\r\n      },\r\n\r\n      handleSourceSelect() {\r\n        let queryParams = {};\r\n        queryParams['supplier_id'] = this.form.getFieldValue('supplierId');\r\n        this.$refs.selectModal.initQueryParams(queryParams);\r\n        this.$refs.selectModal.visible = true;\r\n      },\r\n      handleSourceSelectCallback(selectedRows){\r\n        if ( this.model.sourceId === selectedRows[0]['id']) return;\r\n\r\n        this.model.sourceId = selectedRows[0]['id'];\r\n        this.form.setFieldsValue({sourceNo: selectedRows[0]['bill_no'],\r\n          supplierId: selectedRows[0]['supplier_id']});\r\n\r\n        // 加载子表数据\r\n        let params = { id: this.model.sourceId }\r\n        this.requestSubTableData(this.url.stkIoBillEntry.list, params, this.sourceStkIoBillEntryTable, this.refreshDisabledRows);\r\n      },\r\n\r\n      handleAddEntry(){\r\n        let source = this.$refs.sourceStkIoBillEntry,\r\n            target = this.$refs.stkIoBillEntry;\r\n\r\n        let { values } = source.getValuesSync({ validate: false, rowIds: source.selectedRowIds});\r\n        for(let v of values) {\r\n          let row = pick(v, 'entryNo','materialId','unitId','isInclTax','warehouseId','batchNo','settlePrice','taxRate');\r\n          row.sourceType = 'stk_io_bill.stk_io_bill_entry.101';\r\n          row.sourceEntryId = v.id;\r\n          row.sourceEntryNo = this.form.getFieldValue(\"sourceNo\") + '.' + v.entryNo;\r\n          row.qty = -v.qty;\r\n          row.cost = -v.cost;\r\n          row.settleQty = -v.settleQty;\r\n          row.tax = -v.tax;\r\n          row.discountAmt = -v.discountAmt\r\n          row.discountTax = -v.discountTax\r\n          row.settleAmt = -v.settleAmt;\r\n          target.add();\r\n          let rowId = target.rows[target.rows.length - 1].id;\r\n          target.setValues([{rowKey: rowId, values: row}]);\r\n        }\r\n        this.refreshDisabledRows();\r\n      },\r\n\r\n      handleRemoveEntry(){\r\n        this.$refs.stkIoBillEntry.removeSelectedRows();\r\n        this.refreshDisabledRows();\r\n      },\r\n\r\n      refreshDisabledRows(){\r\n        let that = this;\r\n        let entryNos = [];\r\n        let { values } = that.$refs.stkIoBillEntry.getValuesSync({ validate: false});\r\n        for(let v of values) {\r\n          entryNos.push(Number(v.entryNo));\r\n        }\r\n        that.sourceStkIoBillEntryTable.disabledRows = entryNos.length===0 ? {} : {entryNo:entryNos};\r\n        //disabledRowIds不初始会保留前面的数据，导致与disabledRows不一致！\r\n        that.$refs.sourceStkIoBillEntry.disabledRowIds = [];\r\n        //使新的disabledRows生效\r\n        let dataSource = [...that.sourceStkIoBillEntryTable.dataSource];\r\n        that.sourceStkIoBillEntryTable.dataSource = dataSource;\r\n      },\r\n\r\n      validateRubric(type, value, row, column, callback, target) {\r\n        if (type !== 'blur') {\r\n          callback();\r\n          return;\r\n        }\r\n\r\n        let { values } = target.getValuesSync({ validate: false, rowIds: [row.id]});\r\n        let rubric = Number(values[0][column.key]);\r\n        if (isNaN(rubric)) {\r\n          callback();\r\n          return;\r\n        }\r\n\r\n        let sourceEntryId = values[0].sourceEntryId;\r\n        let rows = this.sourceStkIoBillEntryTable.dataSource.filter(row => row.id === sourceEntryId);\r\n        let blue = rows[0][column.key]\r\n        if (isNaN(blue)) {\r\n          callback();\r\n          return;\r\n        }\r\n\r\n        if (-rubric > blue) {\r\n          callback(false, '不能超出入库！');\r\n          return;\r\n        }\r\n\r\n        callback(true); //true：通过验证\r\n      },\r\n\r\n    },\r\n\r\n  }\r\n</script>\r\n\r\n<style lang=\"less\" scoped>\r\n  .ant-row.ant-form-item {\r\n    margin-bottom: 12px;\r\n  }\r\n</style>\r\n"]}]}