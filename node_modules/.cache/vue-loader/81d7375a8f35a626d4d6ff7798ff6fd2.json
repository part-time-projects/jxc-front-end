{"remainingRequest":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\ideaworkspace\\jxc-front-end\\src\\views\\erp\\finance\\modules\\PayableCheckModal.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\ideaworkspace\\jxc-front-end\\src\\views\\erp\\finance\\modules\\PayableCheckModal.vue","mtime":1648374777625},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1648365135345},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\thread-loader\\dist\\cjs.js","mtime":1648365139913},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\babel-loader\\lib\\index.js","mtime":1648365068269},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1648365135345},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\vue-loader\\lib\\index.js","mtime":1648364957239}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport pick from 'lodash.pick'\nimport JDate from '@/components/jeecg/JDate'\nimport JDictSelectTag from \"@/components/dict/JDictSelectTag\"\nimport { getAction, putAction, httpAction } from '@api/manage'\nimport splitPane from 'vue-splitpane';\nimport { getFormatDate } from \"../../utils/util\"\nimport RpCheckPayableList from \"./RpCheck/RpCheckPayableList\";\nimport RpCheckPaymentList from \"./RpCheck/RpCheckPaymentList\";\nimport RpCheckEntryList from \"./RpCheck/RpCheckEntryList\";\n\nexport default {\n  name: 'PayableCheckModal',\n  components: {\n    JDate,\n    JDictSelectTag,\n    RpCheckPayableList,\n    RpCheckPaymentList,\n    RpCheckEntryList,\n    splitPane\n  },\n\n  data() {\n    return {\n      action: \"\",\n      title: '操作',\n      width: '1200px',\n      visible: false,\n      form: this.$form.createForm(this),\n      confirmLoading: false,\n      model: {},\n\n      moreStatus: false,\n      spans: {\n        labelCol: { span: 3 },\n        wrapperCol: { span: 21 },\n        labelCol1: { span: 2 },\n        wrapperCol1: { span: 22 },\n        labelCol2: { span: 4 },\n        wrapperCol2: { span: 20 },\n        labelCol3: { span: 6 },\n        wrapperCol3: { span: 18 },\n        labelCol6: { span: 12 },\n        wrapperCol6: { span: 12 }\n      },\n\n      validatorRules: {\n        billNo: {rules: [{required: true, message: '请输入单据编号!'}]},\n        billDate: {rules: [{required: true, message: '请输入单据日期!'}]},\n        payableCheckType: {rules: []},\n        supplierId: {rules: []},\n        remark: {rules: []},\n        billProcStatus: {rules: []},\n        isApproved: {rules: []},\n        isClosed: {rules: []},\n        isVoided: {rules: []},\n        effectiveTime: {rules: []},\n        approverId: {rules: []},\n        flowId: {rules: []},\n        createTime: {rules: []},\n        createBy: {rules: []},\n        sysOrgCode: {rules: []},\n        updateTime: {rules: []},\n        updateBy: {rules: []},\n      },\n\n      totalAmt1:0,\n      entryCount1: 0,\n      payableCount: 0,\n      selectedEntryCount1: 0,\n      selectedPayableCount: 0,\n      totalAmt2:0,\n      entryCount2: 0,\n      paymentCount: 0,\n      selectedEntryCount2: 0,\n      selectedPaymentCount: 0,\n\n      url: {\n        add: \"/finance/finPayableCheck/add\",\n        edit: \"/finance/finPayableCheck/edit\",\n        approve: \"/finance/finPayableCheck/approve\",\n        finRpCheckEntry: {\n          list: '/finance/finPayableCheck/queryFinPayableCheckEntryByMainId'\n        },\n      }\n    }\n  },\n\n  computed: {\n    readOnly: function() {\n      return this.action !== \"add\" && this.action !== \"edit\"\n    },\n    payableHeight: function () {\n      let a = this.payableCount === 0 ? 4.5:this.payableCount,\n          b = this.entryCount1 === 0 ? 4.5:this.entryCount1;\n      return (a > b ? a : b) * 38 + 150;\n    },\n    splitPaneHeight: function () {\n      let a = this.paymentCount === 0 ? 4.5:this.paymentCount,\n        b = this.entryCount2 === 0 ? 4.5:this.entryCount2;\n      return this.payableHeight + (a > b ? a : b) * 38 + 180;\n    },\n  },\n\n  methods: {\n    addInit() {\n      this.model = {};\n      //应付核销类型：付款核应付\n      this.model.payableCheckType = '201';\n      //处理状态：编辑中\n      this.model.billProcStatus = '12';\n\n      // 请求后台的填值规则接口地址\n      const url = '/sys/fillRule/executeRuleByCode/'\n      const ruleCode = 'payable_check_bill_no'\n      const that = this\n      putAction(url + ruleCode, {}).then(res => {\n        // 执行成功，获取返回的值，并赋到页面上\n        if (res.success) {\n          that.$nextTick(() => {\n            that.form.setFieldsValue({'billNo':res.result, 'billDate':getFormatDate()})\n          })\n        }\n      })\n    },\n\n    /** 列表点击新增按钮时调用此方法 */\n    add() {\n      this.addInit();\n      this.edit(this.model);\n    },\n\n    resetModal() {\n      // reset modal\n      this.entryCount1 = 0;\n      this.selectedEntryCount1= 0;\n      this.selectedPayableCount = 0;\n      this.entryCount2 = 0;\n      this.selectedEntryCount2 = 0;\n      this.selectedPaymentCount = 0;\n      this.form.resetFields();\n      this.$nextTick(() => {\n        this.$refs.rpCheckEntryList1.resetTable();\n        this.$refs.rpCheckEntryList2.resetTable();\n        if (!this.readOnly) {\n          this.$refs.rpCheckPayableList.resetTable();\n          this.$refs.rpCheckPaymentList.resetTable();\n        }\n      });\n    },\n\n    /** 列表点击了编辑（修改）按钮时调用此方法 */\n    edit(record) {\n      this.resetModal();\n\n      this.model = Object.assign({}, record);\n      this.visible = true;\n      this.$nextTick(() => {\n        this.form.setFieldsValue(pick(this.model,'billNo','billDate','supplierId','remark','billProcStatus','isApproved','isClosed','isVoided','effectiveTime','approverId','flowId','createTime','createBy','sysOrgCode','updateTime','updateBy'))\n      })\n\n      // 加载子表数据\n      this.$nextTick(() => {\n        if (this.model.id) {\n          queryCheckEntry(this);\n          this.onSupplierChange(this.model.supplierId);\n        }\n      });\n\n      /** 查询数据 */\n      function queryCheckEntry(that) {\n        let url = that.url.finRpCheckEntry.list;\n        let params = { id: that.model.id };\n        that.$refs.rpCheckEntryList1.loading = true;\n        that.$refs.rpCheckEntryList2.loading = true;\n        getAction(url, params).then(res => {\n          let records1 = [], records2 = [];\n          for (let record of res.result || []) {\n            if (record.checkSide === \"1\")\n              records1.push(record)\n            else\n              records2.push(record);\n          }\n          that.$refs.rpCheckEntryList1.dataSource = records1;\n          that.$refs.rpCheckEntryList2.dataSource = records2;\n        }).finally(() => {\n          that.$refs.rpCheckEntryList1.loading = false;\n          that.$refs.rpCheckEntryList2.loading = false;\n        });\n      }\n    },\n\n    onSupplierChange(val){\n      if (!this.readOnly && val) {\n        let params = {supplierId: val};\n        this.$refs.rpCheckPayableList.queryParam = params;\n        this.$refs.rpCheckPayableList.loadData(1);\n        this.$refs.rpCheckPaymentList.queryParam = params;\n        this.$refs.rpCheckPaymentList.loadData(1);\n      }\n    },\n\n    onPayableDataSourceChange() {\n      this.payableCount = this.$refs.rpCheckPayableList.dataSource.length;\n      this.makeAdded(this.$refs.rpCheckPayableList, this.$refs.rpCheckEntryList1);\n    },\n\n    //注意：\n    // rpCheckPayableList与rpCheckPaymentList的loadData(),由于其中getAction是异步执行，\n    // 所以如果在其后调用本函数将无效（此时rpCheckPayableList.dataSource还是空的）。\n    makeAdded(fromComponent, toComponent) {\n      let records = [];\n      let change = false;\n      for (let fromRecord of fromComponent.dataSource) {\n        let added = false;\n        for (let toRecord of toComponent.dataSource) {\n          if (fromRecord.id === toRecord.sourceId) {\n            added = true;\n            if (fromRecord.added !== \"是\") {\n              fromRecord.added = \"是\";\n              change = true;\n            }\n            break;\n          }\n        }\n        // 以前是added，但现在不是\n        if (!added && fromRecord.added === \"是\") {\n          fromRecord.added = \"\";\n          change = true;\n        }\n        records.push(fromRecord);\n      }\n      if (change) {\n        //避免循环触发dataSourceChange\n        fromComponent.disableDataSourceChange = true;\n        fromComponent.dataSource = records;\n      }\n    },\n\n    onPayableSelectChange(){\n      let count = 0;\n      for (let payable of  this.$refs.rpCheckPayableList.selectionRows) {\n        if (payable.added !== \"是\") count++;\n      }\n      this.selectedPayableCount = count;\n    },\n\n    onEntryList1SelectChange() {\n      this.selectedEntryCount1 = this.$refs.rpCheckEntryList1.selectedRowKeys.length;\n    },\n\n    onEntryList1DataSourceChange(){\n      this.entryCount1 = this.$refs.rpCheckEntryList1.dataSource.length;\n    },\n\n    onPaymentDataSourceChange() {\n      this.paymentCount = this.$refs.rpCheckPaymentList.dataSource.length;\n      this.makeAdded(this.$refs.rpCheckPaymentList, this.$refs.rpCheckEntryList2);\n    },\n\n    onPaymentSelectChange(){\n      let count = 0;\n      for (let payment of this.$refs.rpCheckPaymentList.selectionRows) {\n        if (payment.added !== \"是\") count++;\n      }\n      this.selectedPaymentCount = count;\n    },\n\n    onEntryList2SelectChange() {\n      this.selectedEntryCount2 = this.$refs.rpCheckEntryList2.selectedRowKeys.length;\n    },\n\n    onEntryList2DataSourceChange(){\n      this.entryCount2 = this.$refs.rpCheckEntryList2.dataSource.length;\n    },\n\n    handleEntryList1Add() {\n      let maxEntryNo = 100;\n      for(let record of this.$refs.rpCheckEntryList1.dataSource) {\n        if (maxEntryNo < record.entryNo)  maxEntryNo = record.entryNo;\n      }\n\n      let records = [];\n      for (let record of this.$refs.rpCheckPayableList.selectionRows) {\n        if (record.added !== \"是\") {\n          records.push({\n            entryNo: ++maxEntryNo,\n            checkSide: \"1\",\n            sourceType: \"fin_payable\",\n            sourceId: record.id,\n            sourceNo: record.billNo,\n            uncheckedAmt: record.uncheckedAmt,\n            amt: record.uncheckedAmt\n          });\n        }\n      }\n      this.$refs.rpCheckEntryList1.dataSource.push(...records);\n      this.selectedPayableCount = 0;\n      this.$refs.rpCheckPayableList.selectedRowKeys = [];\n      this.$refs.rpCheckPayableList.selectionRows = [];\n      this.makeAdded(this.$refs.rpCheckPayableList, this.$refs.rpCheckEntryList1);\n    },\n\n    handleEntryList1Remove() {\n      if (this.$refs.rpCheckEntryList1.selectionRows === 0) return;\n\n      let records = [];\n      for (let record of this.$refs.rpCheckEntryList1.dataSource) {\n        let removedRecord = {sourceId:\"\"};\n        for (removedRecord of this.$refs.rpCheckEntryList1.selectionRows) {\n          //移除的\n          if (record.sourceId === removedRecord.sourceId) break;\n        }\n        //不移除的\n        if (record.sourceId !== removedRecord.sourceId) records.push(record);\n      }\n      this.$refs.rpCheckEntryList1.dataSource = records;\n      this.selectedEntryCount1 = 0;\n      this.$refs.rpCheckEntryList1.selectedRowKeys = [];\n      this.$refs.rpCheckEntryList1.selectionRows = [];\n      this.makeAdded(this.$refs.rpCheckPayableList, this.$refs.rpCheckEntryList1);\n    },\n\n    handleEntryList2Add() {\n      let maxEntryNo = 200;\n      for(let record of this.$refs.rpCheckEntryList2.dataSource) {\n        if (maxEntryNo < record.entryNo)  maxEntryNo = record.entryNo;\n      }\n\n      let records = [];\n      for (let record of this.$refs.rpCheckPaymentList.selectionRows) {\n        if (record.added !== \"是\") {\n          records.push({\n            entryNo: ++maxEntryNo,\n            checkSide: \"2\",\n            sourceType: \"fin_payment..202\",\n            sourceId: record.id,\n            sourceNo: record.billNo,\n            uncheckedAmt: record.uncheckedAmt,\n            amt: record.uncheckedAmt\n          });\n        }\n      }\n      this.$refs.rpCheckEntryList2.dataSource.push(...records);\n      this.selectedPaymentCount = 0;\n      this.$refs.rpCheckPaymentList.selectedRowKeys = [];\n      this.$refs.rpCheckPaymentList.selectionRows = [];\n      this.makeAdded(this.$refs.rpCheckPaymentList, this.$refs.rpCheckEntryList2);\n    },\n\n    handleEntryList2Remove() {\n      if (this.$refs.rpCheckEntryList2.selectionRows === 0) return;\n\n      let records = [];\n      for (let record of this.$refs.rpCheckEntryList2.dataSource) {\n        let removedRecord = {sourceId:\"\"};\n        for (removedRecord of this.$refs.rpCheckEntryList2.selectionRows) {\n          //移除的\n          if (record.sourceId === removedRecord.sourceId) break;\n        }\n        //不移除的\n        if (record.sourceId !== removedRecord.sourceId) records.push(record);\n      }\n      this.$refs.rpCheckEntryList2.dataSource = records;\n      this.selectedEntryCount2 = 0;\n      this.$refs.rpCheckEntryList2.selectedRowKeys = [];\n      this.$refs.rpCheckEntryList2.selectionRows = [];\n      this.makeAdded(this.$refs.rpCheckPaymentList, this.$refs.rpCheckEntryList2);\n    },\n\n    /** 关闭弹窗，并将所有JEditableTable实例回归到初始状态 */\n    close() {\n      this.visible = false\n      this.$emit('close')\n    },\n\n    handleOk () {\n      // 触发表单验证\n      this.form.validateFields((err, values) => {\n        if (!err) {\n          let formData = this.classifyIntoFormData(values);\n          return this.request(formData, false)\n        }\n      })\n    },\n\n    /** 整理成formData */\n    classifyIntoFormData(formValue) {\n      let main = Object.assign(this.model, formValue)\n      return {\n        ...main, // 展开\n        finPayableCheckEntryList: this.$refs.rpCheckEntryList1.dataSource.concat(this.$refs.rpCheckEntryList2.dataSource),\n      }\n    },\n\n    /** 发起请求，自动判断是执行新增还是修改操作 */\n    request(formData, isSubmit) {\n      let url = this.url.add, method = 'post'\n      if (this.model.id) {\n        url = this.url.edit\n        method = 'put'\n      }\n\n      this.confirmLoading = true;\n      httpAction(url, formData, method).then((res) => {\n        if (res.success) {\n          this.$message.success(res.message)\n          this.$emit('ok')\n          this.close()\n        } else {\n          this.$message.warning(res.message)\n        }\n      }).catch(e => {\n         if (isSubmit)  this.form.setFieldsValue({billProcStatus:'12'});\n      }).finally(() => {\n        this.confirmLoading = false\n      })\n    },\n\n\n    handleCancel () {\n      this.close()\n    },\n    handleSave() {\n      this.handleOk()\n    },\n\n    handleSubmit() {\n      //处理状态=编辑完成\n      this.form.setFieldsValue({billProcStatus:'13'})\n\n      //出错时要恢复billProcStatus为\"12\"，所以下面未直接调用handleSave()！\n      // 触发表单验证\n      this.form.validateFields((err, values) => {\n        if (!err) {\n          let formData = this.classifyIntoFormData(values);\n          return this.request(formData, true)\n        }\n      })\n    },\n\n    handleApproved() {\n      const that = this;\n      putAction(that.url.approve, {id: that.model.id}).then((res) => {\n        if (res.success) {\n          that.$message.success(res.message);\n          that.$emit('ok')\n          that.close()\n        } else {\n          that.$message.warning(res.message);\n        }\n      })\n    },\n\n    popupCallback(row){\n      this.form.setFieldsValue(pick(row,'billNo','billDate','supplierId','remark','billProcStatus','isApproved','isClosed','isVoided','effectiveTime','approverId','flowId','createTime','createBy','sysOrgCode','updateTime','updateBy'))\n    },\n\n  }\n}\n",null]}