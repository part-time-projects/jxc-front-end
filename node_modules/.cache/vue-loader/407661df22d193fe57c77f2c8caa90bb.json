{"remainingRequest":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\ideaworkspace\\jxc-front-end\\src\\views\\erp\\stock\\modules\\CheckBillModal.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\ideaworkspace\\jxc-front-end\\src\\views\\erp\\stock\\modules\\CheckBillModal.vue","mtime":1648374777643},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1648365135345},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\babel-loader\\lib\\index.js","mtime":1648365068269},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1648365135345},{"path":"D:\\ideaworkspace\\jxc-front-end\\node_modules\\vue-loader\\lib\\index.js","mtime":1648364957239}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n\nimport pick from 'lodash.pick'\nimport { FormTypes,getRefPromise,VALIDATE_NO_PASSED, validateFormAndTables } from '@/utils/JEditableTableUtil'\nimport { JEditableTableMixin } from '@/mixins/JEditableTableMixin'\nimport JDate from '@/components/jeecg/JDate'\nimport JUpload from '@/components/jeecg/JUpload'\nimport JDictSelectTag from \"@/components/dict/JDictSelectTag\"\nimport { putAction } from '@api/manage'\nimport { billModalMixin } from '../../mixins/billModalMixin'\nimport { getFormatDate } from '../../utils/util'\n\nexport default {\n  name: 'CheckBillModal',\n  mixins: [JEditableTableMixin, billModalMixin],\n  components: {\n    JDate,\n    JUpload,\n    JDictSelectTag\n  },\n\n  data() {\n    return {\n      width: '1200px',\n      moreStatus: false,\n      entryNoStep: 1, //分录号自动编号步长\n\n      //盘点范围\n      checkRange: {},\n      lastCheckRange: {},\n\n      // 新增时子表默认添加几行空数据\n      addDefaultRowNum: 0,\n      validatorRules: {\n        billNo: {\n          rules: [\n            { required: true, message: '请输入单据编号!'},\n          ]\n        },\n        billDate: {\n          rules: [\n            { required: true, message: '请输入单据日期!'},\n          ]\n        },\n        warehouseId: {\n          rules: [\n            { required: true, message: '请选择仓库!'},\n          ]\n        },\n      },\n      refKeys: ['stkCheckBillEntry', 'stkCheckBillEntryNew',],\n      tableKeys:['stkCheckBillEntry', 'stkCheckBillEntryNew',],\n      activeKey: 'stkCheckBillEntry',\n      // 明细\n      stkCheckBillEntryTable: {\n        loading: false,\n        dataSource: [],\n        columns: [\n          {\n            title: '序号',\n            key: 'entryNo',\n            type: FormTypes.input,\n            width:\"70px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            disabled:true,\n          },\n          {\n            title: '是否新批次',\n            key: 'isNewBatch',\n            type: FormTypes.hidden,\n            width:\"1px\",\n            defaultValue: '0',\n            disabled:true,\n          },\n          {\n            title: '仓库',\n            key: 'warehouseId',\n            type: FormTypes.select,\n            dictCode:\"bas_warehouse,name,id\",\n            width:\"150px\",\n            defaultValue: '',\n            options:[],\n            disabled:true,\n          },\n          {\n            title: '物料',\n            key: 'materialId',\n            type: FormTypes.select,\n            dictCode:\"bas_material,name,id\",\n            width:\"150px\",\n            defaultValue: '',\n            options:[],\n            disabled:true,\n          },\n          {\n            title: '批号',\n            key: 'batchNo',\n            type: FormTypes.input,\n            width:\"220px\",\n            defaultValue: '',\n            disabled:true,\n         },\n          {\n            title: '供应商',\n            key: 'supplierId',\n            type: FormTypes.select,\n            dictCode:\"bas_supplier,name,id\",\n            width:\"150px\",\n            defaultValue: '',\n            disabled:true,\n          },\n          {\n            title: '计量单位',\n            key: 'unitId',\n            type: FormTypes.select,\n            dictCode:\"bas_measure_unit,name,id\",\n            width:\"100px\",\n            defaultValue: '',\n            options:[],\n            disabled:true,\n          },\n          {\n            title: '账存数量',\n            key: 'bookQty',\n            type: FormTypes.input,\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '0',\n            disabled:true,\n          },\n          {\n            title: '实存数量',\n            key: 'qty',\n            type: FormTypes.inputNumber,\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '盈亏',\n            key: 'profitQty',\n            type: FormTypes.inputNumber,\n            width:\"100px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n            disabled:true,\n          },\n          {\n            title: '备注',\n            key: 'remark',\n            type: FormTypes.input,\n            width:\"200px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '备注2',\n            key: 'remark2',\n            type: FormTypes.input,\n            width:\"200px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '备注3',\n            key: 'remark3',\n            type: FormTypes.input,\n            width:\"200px\",\n            placeholder: '请输入${title}',\n            defaultValue: '',\n          },\n          {\n            title: '',\n            key: 'flag',\n            type: FormTypes.hidden,\n            width:\"1px\",\n            placeholder: '',\n            defaultValue: '',\n          },\n        ],\n        dataSourceNew: [],\n        columnsNew: []\n      },\n      url: {\n        add: \"/stock/stkCheckBill/add\",\n        edit: \"/stock/stkCheckBill/edit\",\n        approve: \"/stock/stkCheckBill/approve\",\n        stkCheckBillEntry: {\n          list: '/stock/stkCheckBill/queryStkCheckBillEntryByMainId',\n          listByRange: '/stock/stkCheckBill/queryStkCheckBillEntryByRange'\n        },\n      }\n    }\n  },\n\n  computed: {\n    isCheckRangeChange: function () {\n      return this.checkRange.warehouseId !== this.lastCheckRange.warehouseId ||\n        this.checkRange.materialCategoryId !== this.lastCheckRange.materialCategoryId;\n    }\n  },\n\n  created() {\n    for(let col of this.stkCheckBillEntryTable.columns){\n      let col2 = Object.assign({}, col);\n      if (!['entryNo', 'isNewBatch', 'bookQty', 'profitQty'].includes(col2.key)) col2.disabled = false;\n      if (col2.key==='isNewBatch') col2.defaultValue = '1';\n      if (col2.key==='bookQty') col2.defaultValue = '0';\n      this.stkCheckBillEntryTable.columnsNew.push(col2);\n     }\n  },\n\n  methods: {\n    getAllTable() {\n      let values = this.tableKeys.map(key => getRefPromise(this, key))\n      return Promise.all(values)\n    },\n\n    addInit() {\n      this.checkRange = { warehouseId: '',  materialCategoryId:''}\n      this.lastCheckRange = Object.assign({}, this.checkRange);\n\n      //处理状态：编辑中\n      this.model.billProcStatus = '12'\n\n      // 请求后台的填值规则接口地址\n      const url = '/sys/fillRule/executeRuleByCode/'\n      const ruleCode = 'stock_check_bill_no'\n      const that = this\n      putAction(url + ruleCode, {}).then(res => {\n        // 执行成功，获取返回的值，并赋到页面上\n        if (res.success) {\n          that.model.billNo = res.result;\n          that.$nextTick(() => {\n            that.form.setFieldsValue({'billNo':res.result, 'billDate':getFormatDate()})\n          })\n        }\n      })\n    },\n    /** 调用完edit()方法之后会自动调用此方法 */\n    editAfter() {\n      let columns = this.stkCheckBillEntryTable.columns.filter(col => col.key === 'qty');\n      if (this.action === 'add') {\n        this.addInit();\n        columns[0].validateRules = [{}];\n      } else if (this.action === 'edit') {\n        columns[0].validateRules = [{ required: true, message: '${title}不能为空' }];\n      }\n\n      let fieldval = pick(this.model,'billNo','billDate','warehouseId','materialCategoryId','checkerId','attachment','remark','billProcStatus','approverId','flowId','isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime')\n      this.$nextTick(() => {\n        this.form.setFieldsValue(fieldval)\n      })\n      // 加载子表数据\n      if (this.model.id) {\n        const that = this;\n        let params = { id: this.model.id }\n        this.requestSubTableData(this.url.stkCheckBillEntry.list, params, this.stkCheckBillEntryTable, splitData)\n\n        function splitData(){\n          let dataSource = [], dataSourceNew = [];\n          for(let row of that.stkCheckBillEntryTable.dataSource) {\n            if (row.isNewBatch===0) {\n              dataSource.push(row);\n            } else {\n              dataSourceNew.push(row);\n            }\n          }\n          dataSource.sort((a, b) => a.entryNo - b.entryNo);\n          that.stkCheckBillEntryTable.dataSource = dataSource;\n          dataSourceNew.sort((a, b) => a.entryNo - b.entryNo);\n          that.stkCheckBillEntryTable.dataSourceNew = dataSourceNew;\n        }\n      }\n    },\n\n    /** 整理成formData */\n    classifyIntoFormData(allValues) {\n      let main = Object.assign(this.model, allValues.formValue)\n      return {\n        ...main, // 展开\n        stkCheckBillEntryList: allValues.tablesValue[0].values.concat(allValues.tablesValue[1].values),\n      }\n    },\n\n    validateError(msg){\n      this.$message.error(msg)\n    },\n\n    popupCallback(row){\n      this.form.setFieldsValue(pick(row,'billNo','billDate','warehouseId','materialCategoryId','checkerId','attachment','remark','billProcStatus','approverId','flowId','isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime'))\n    },\n\n    handleCheckRangeOk(){\n      this.requestSubTableData(this.url.stkCheckBillEntry.listByRange, this.checkRange, this.stkCheckBillEntryTable);\n      this.lastCheckRange = Object.assign({}, this.checkRange);\n    },\n\n    onInEntryAdded(event){\n      this.onEntryAdded(event);\n\n      const { row, target } = event\n      let { values } = target.getValuesSync({ validate: false, rowIds: [row.id] });\n      let batchNo =  this.model.billNo + \"-\" + values[0].entryNo;\n      target.setValues([{rowKey: row.id, values: {batchNo: batchNo, flag: \"1\"}}]);\n   },\n\n    onValueChange(event) {\n      const { type, row, column, value, target } = event\n\n      //flag: 是否自动设置的batchNo\n      if (row.flag == null || row.flag === \"\") {\n        target.setValues([{rowKey: row.id, values: {flag: \"0\"}}]);\n      }\n      if (column.key === \"entryNo\" && (row.flag === \"1\" || row.batchNo === \"\" || row.batchNo == null)) {\n        target.setValues([{rowKey: row.id, values: {batchNo: this.model.billNo + \"-\" + value, flag: \"1\"}}]);\n      }\n      else if (column.key === \"batchNo\") {\n        target.setValues([{rowKey: row.id, values: {flag: \"0\"}}]);\n      }\n\n      //qty 实存数量 --> profitQty 盈亏数量\n      if (column.key === 'qty') {\n        let qty = Number(value);\n        let bookQty = Number(row.bookQty);\n        if (!isNaN(qty) && !isNaN(bookQty)){\n          target.setValues([{rowKey: row.id, values: {profitQty:  qty - bookQty}}]);\n        }\n      }\n    },\n\n  }\n}\n",{"version":3,"sources":["CheckBillModal.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA","file":"CheckBillModal.vue","sourceRoot":"src/views/erp/stock/modules","sourcesContent":["<template>\r\n  <j-modal\r\n    :title=\"'库存盘点卡 - ' + title\"\r\n    :width=\"width\"\r\n    :visible=\"visible\"\r\n    :confirmLoading=\"confirmLoading\"\r\n    :maskClosable=\"false\"\r\n    :keyboard=\"false\"\r\n    :forceRender=\"true\"\r\n    switchFullscreen\r\n    @ok=\"handleOk\"\r\n    @cancel=\"handleCancel\">\r\n\r\n    <template slot=\"footer\">\r\n      <a-button v-if=\"action!=='detail'\" key=\"cancel\" @click=\"handleCancel\">取消</a-button>\r\n      <a-button v-if=\"action==='add'\" key=\"ok\"  @click=\"handleOk\" type=\"primary\" :loading=\"confirmLoading\">确定</a-button>\r\n      <a-button v-if=\"action==='edit'\" key=\"save\"   @click=\"handleSave\" type=\"primary\" :loading=\"confirmLoading\">保存</a-button>\r\n      <a-button v-if=\"action==='edit'\" key=\"submit\" @click=\"handleSubmit\" type=\"primary\" :loading=\"confirmLoading\">提交</a-button>\r\n      <a-button v-if=\"action==='detail'\"  key=\"close\"  @click=\"handleCancel\" type=\"primary\">关闭</a-button>\r\n      <a-button v-if=\"action==='approve'\"  key=\"approved\"  @click=\"handleApproved\" type=\"primary\">审核通过</a-button>\r\n    </template>\r\n\r\n    <a-spin :spinning=\"confirmLoading\">\r\n      <!-- 主表单区域 -->\r\n      <a-form :form=\"form\">\r\n        <a-row>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"处理状态\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['billProcStatus']\" :trigger-change=\"true\" dictCode=\"x_bill_proc_status\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a-form-item label=\"是否通过\" :labelCol=\"spans.labelCol6\" :wrapperCol=\"spans.wrapperCol6\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['isApproved']\" :trigger-change=\"true\" dictCode=\"yn\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a-form-item label=\"是否关闭\" :labelCol=\"spans.labelCol6\" :wrapperCol=\"spans.wrapperCol6\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['isClosed']\" :trigger-change=\"true\" dictCode=\"yn\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a-form-item label=\"是否作废\" :labelCol=\"spans.labelCol6\" :wrapperCol=\"spans.wrapperCol6\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['isVoided']\" :trigger-change=\"true\" dictCode=\"yn\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"4\">\r\n            <a @click=\"()=> moreStatus = !moreStatus\" style=\"float: right; margin-top: 10px\">\r\n              {{ moreStatus ? '收起' : '展开' }}\r\n              <a-icon :type=\"moreStatus ? 'up' : 'down'\"/>\r\n            </a>\r\n          </a-col>\r\n        </a-row>\r\n        <a-row v-show=\"moreStatus\">\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"创建时间\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"true\" v-decorator=\"[ 'createTime', validatorRules.createTime]\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"创建人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['createBy', validatorRules.createBy]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"创建部门\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['sysOrgCode', validatorRules.sysOrgCode]\" :trigger-change=\"true\" dictCode=\"sys_depart,depart_name,org_code\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"生效时间\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"true\" v-decorator=\"[ 'effectiveTime', validatorRules.effectiveTime]\" :showTime=\"true\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"审核人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['approverId', validatorRules.approverId]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"流程\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <a-input :readOnly=\"true\" v-decorator=\"[ 'flowId', validatorRules.flowId]\" ></a-input>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"修改时间\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"true\" v-decorator=\"[ 'updateTime', validatorRules.updateTime]\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"修改人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled type=\"list\" v-decorator=\"['updateBy', validatorRules.updateBy]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"是否红字\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag type=\"list\" v-decorator=\"['isRubric', validatorRules.isRubric]\" :trigger-change=\"true\" dictCode=\"yn\" />\r\n            </a-form-item>\r\n          </a-col>\r\n        </a-row>\r\n        <a-row>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"单据编号\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <a-input :readOnly=\"true\" v-decorator=\"[ 'billNo', validatorRules.billNo]\" ></a-input>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"单据日期\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-date :readOnly=\"readOnly\" placeholder=\"请选择单据日期\" v-decorator=\"[ 'billDate', validatorRules.billDate]\" :trigger-change=\"true\" style=\"width: 100%\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item  label=\"制单人\" :labelCol=\"spans.labelCol3\" :wrapperCol=\"spans.wrapperCol3\">\r\n              <j-dict-select-tag disabled  type=\"list\" v-decorator=\"['createBy', validatorRules.createBy]\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" />\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"盘点人\" :labelCol=\"labelCol\" :wrapperCol=\"wrapperCol\">\r\n              <j-dict-select-tag type=\"list\" v-decorator=\"['checkerId']\" :trigger-change=\"true\" dictCode=\"sys_user,realname,username\" placeholder=\"请选择盘点人\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"16\">\r\n            <a-form-item label=\"备注\" :labelCol=\"spans.labelCol1_5\" :wrapperCol=\"spans.wrapperCol1_5\">\r\n              <a-textarea :readOnly=\"readOnly\" v-decorator=\"[ 'remark', validatorRules.remark]\"  rows=\"1\" autoSize></a-textarea>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"24\">\r\n            <a-form-item label=\"附件\" :labelCol=\"spans.labelCol1\" :wrapperCol=\"spans.wrapperCol1\">\r\n              <j-upload :disabled=\"readOnly\" v-decorator=\"['attachment', validatorRules.attachment]\" :trigger-change=\"true\"></j-upload>\r\n            </a-form-item>\r\n          </a-col>\r\n        </a-row>\r\n        <a-divider orientation=\"left\" style=\"font-size: 14px; color: #bfbfbf;\">盘点范围</a-divider>\r\n        <a-row>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"仓库\" :labelCol=\"labelCol\" :wrapperCol=\"wrapperCol\">\r\n              <j-dict-select-tag :disabled=\"action!=='add'\" type=\"list\" v-decorator=\"['warehouseId', validatorRules.warehouseId]\" :trigger-change=\"true\"\r\n                                 @change=\"(val) => this.checkRange.warehouseId = val||''\" dictCode=\"bas_warehouse,name,id\" placeholder=\"请选择仓库\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <a-form-item label=\"物料分类\" :labelCol=\"labelCol\" :wrapperCol=\"wrapperCol\">\r\n              <j-dict-select-tag :disabled=\"action!=='add'\"  type=\"list\" v-decorator=\"['materialCategoryId']\" :trigger-change=\"true\"\r\n                                 @change=\"(val) => this.checkRange.materialCategoryId = val||''\" dictCode=\"bas_material_category,name,id\" placeholder=\"请选择物料分类\"/>\r\n            </a-form-item>\r\n          </a-col>\r\n          <a-col :span=\"8\">\r\n            <div v-if=\"action==='add'\">\r\n              <a-button @click=\"handleCheckRangeOk\" :disabled=\"!isCheckRangeChange\" type=\"primary\" style=\"margin: 5px 0 0 36px\">确定</a-button>\r\n            </div>\r\n          </a-col>\r\n        </a-row>\r\n      </a-form>\r\n\r\n      <!-- 子表单区域 -->\r\n      <a-tabs v-model=\"activeKey\" @change=\"handleChangeTabs\">\r\n        <a-tab-pane tab=\"明细\" :key=\"refKeys[0]\" :forceRender=\"true\">\r\n          <j-editable-table\r\n            v-show=\"!isCheckRangeChange\"\r\n            :disabled=\"readOnly\"\r\n            :ref=\"refKeys[0]\"\r\n            :loading=\"stkCheckBillEntryTable.loading\"\r\n            :columns=\"stkCheckBillEntryTable.columns\"\r\n            :dataSource=\"stkCheckBillEntryTable.dataSource\"\r\n            :maxHeight=\"300\"\r\n            :rowNumber=\"false\"\r\n            :rowSelection=\"false\"\r\n            :actionButton=\"false\"\r\n            @valueChange=\"onValueChange\"\r\n          />\r\n        </a-tab-pane>\r\n\r\n        <a-tab-pane :tab=\"action==='add' ? '':'新批次'\" :key=\"refKeys[1]\" :forceRender=\"true\">\r\n          <j-editable-table\r\n            :disabled=\"readOnly\"\r\n            :ref=\"refKeys[1]\"\r\n            :loading=\"stkCheckBillEntryTable.loading\"\r\n            :columns=\"stkCheckBillEntryTable.columnsNew\"\r\n            :dataSource=\"stkCheckBillEntryTable.dataSourceNew\"\r\n            :maxHeight=\"300\"\r\n            :rowNumber=\"false\"\r\n            :rowSelection=\"true\"\r\n            :actionButton=\"!readOnly\"\r\n            @valueChange=\"onValueChange\"\r\n            @added=\"onInEntryAdded\"\r\n          />\r\n        </a-tab-pane>\r\n\r\n      </a-tabs>\r\n    </a-spin>\r\n  </j-modal>\r\n</template>\r\n\r\n<script>\r\n\r\n  import pick from 'lodash.pick'\r\n  import { FormTypes,getRefPromise,VALIDATE_NO_PASSED, validateFormAndTables } from '@/utils/JEditableTableUtil'\r\n  import { JEditableTableMixin } from '@/mixins/JEditableTableMixin'\r\n  import JDate from '@/components/jeecg/JDate'\r\n  import JUpload from '@/components/jeecg/JUpload'\r\n  import JDictSelectTag from \"@/components/dict/JDictSelectTag\"\r\n  import { putAction } from '@api/manage'\r\n  import { billModalMixin } from '../../mixins/billModalMixin'\r\n  import { getFormatDate } from '../../utils/util'\r\n\r\n  export default {\r\n    name: 'CheckBillModal',\r\n    mixins: [JEditableTableMixin, billModalMixin],\r\n    components: {\r\n      JDate,\r\n      JUpload,\r\n      JDictSelectTag\r\n    },\r\n\r\n    data() {\r\n      return {\r\n        width: '1200px',\r\n        moreStatus: false,\r\n        entryNoStep: 1, //分录号自动编号步长\r\n\r\n        //盘点范围\r\n        checkRange: {},\r\n        lastCheckRange: {},\r\n\r\n        // 新增时子表默认添加几行空数据\r\n        addDefaultRowNum: 0,\r\n        validatorRules: {\r\n          billNo: {\r\n            rules: [\r\n              { required: true, message: '请输入单据编号!'},\r\n            ]\r\n          },\r\n          billDate: {\r\n            rules: [\r\n              { required: true, message: '请输入单据日期!'},\r\n            ]\r\n          },\r\n          warehouseId: {\r\n            rules: [\r\n              { required: true, message: '请选择仓库!'},\r\n            ]\r\n          },\r\n        },\r\n        refKeys: ['stkCheckBillEntry', 'stkCheckBillEntryNew',],\r\n        tableKeys:['stkCheckBillEntry', 'stkCheckBillEntryNew',],\r\n        activeKey: 'stkCheckBillEntry',\r\n        // 明细\r\n        stkCheckBillEntryTable: {\r\n          loading: false,\r\n          dataSource: [],\r\n          columns: [\r\n            {\r\n              title: '序号',\r\n              key: 'entryNo',\r\n              type: FormTypes.input,\r\n              width:\"70px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '是否新批次',\r\n              key: 'isNewBatch',\r\n              type: FormTypes.hidden,\r\n              width:\"1px\",\r\n              defaultValue: '0',\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '仓库',\r\n              key: 'warehouseId',\r\n              type: FormTypes.select,\r\n              dictCode:\"bas_warehouse,name,id\",\r\n              width:\"150px\",\r\n              defaultValue: '',\r\n              options:[],\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '物料',\r\n              key: 'materialId',\r\n              type: FormTypes.select,\r\n              dictCode:\"bas_material,name,id\",\r\n              width:\"150px\",\r\n              defaultValue: '',\r\n              options:[],\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '批号',\r\n              key: 'batchNo',\r\n              type: FormTypes.input,\r\n              width:\"220px\",\r\n              defaultValue: '',\r\n              disabled:true,\r\n           },\r\n            {\r\n              title: '供应商',\r\n              key: 'supplierId',\r\n              type: FormTypes.select,\r\n              dictCode:\"bas_supplier,name,id\",\r\n              width:\"150px\",\r\n              defaultValue: '',\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '计量单位',\r\n              key: 'unitId',\r\n              type: FormTypes.select,\r\n              dictCode:\"bas_measure_unit,name,id\",\r\n              width:\"100px\",\r\n              defaultValue: '',\r\n              options:[],\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '账存数量',\r\n              key: 'bookQty',\r\n              type: FormTypes.input,\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '0',\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '实存数量',\r\n              key: 'qty',\r\n              type: FormTypes.inputNumber,\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '盈亏',\r\n              key: 'profitQty',\r\n              type: FormTypes.inputNumber,\r\n              width:\"100px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n              disabled:true,\r\n            },\r\n            {\r\n              title: '备注',\r\n              key: 'remark',\r\n              type: FormTypes.input,\r\n              width:\"200px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '备注2',\r\n              key: 'remark2',\r\n              type: FormTypes.input,\r\n              width:\"200px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '备注3',\r\n              key: 'remark3',\r\n              type: FormTypes.input,\r\n              width:\"200px\",\r\n              placeholder: '请输入${title}',\r\n              defaultValue: '',\r\n            },\r\n            {\r\n              title: '',\r\n              key: 'flag',\r\n              type: FormTypes.hidden,\r\n              width:\"1px\",\r\n              placeholder: '',\r\n              defaultValue: '',\r\n            },\r\n          ],\r\n          dataSourceNew: [],\r\n          columnsNew: []\r\n        },\r\n        url: {\r\n          add: \"/stock/stkCheckBill/add\",\r\n          edit: \"/stock/stkCheckBill/edit\",\r\n          approve: \"/stock/stkCheckBill/approve\",\r\n          stkCheckBillEntry: {\r\n            list: '/stock/stkCheckBill/queryStkCheckBillEntryByMainId',\r\n            listByRange: '/stock/stkCheckBill/queryStkCheckBillEntryByRange'\r\n          },\r\n        }\r\n      }\r\n    },\r\n\r\n    computed: {\r\n      isCheckRangeChange: function () {\r\n        return this.checkRange.warehouseId !== this.lastCheckRange.warehouseId ||\r\n          this.checkRange.materialCategoryId !== this.lastCheckRange.materialCategoryId;\r\n      }\r\n    },\r\n\r\n    created() {\r\n      for(let col of this.stkCheckBillEntryTable.columns){\r\n        let col2 = Object.assign({}, col);\r\n        if (!['entryNo', 'isNewBatch', 'bookQty', 'profitQty'].includes(col2.key)) col2.disabled = false;\r\n        if (col2.key==='isNewBatch') col2.defaultValue = '1';\r\n        if (col2.key==='bookQty') col2.defaultValue = '0';\r\n        this.stkCheckBillEntryTable.columnsNew.push(col2);\r\n       }\r\n    },\r\n\r\n    methods: {\r\n      getAllTable() {\r\n        let values = this.tableKeys.map(key => getRefPromise(this, key))\r\n        return Promise.all(values)\r\n      },\r\n\r\n      addInit() {\r\n        this.checkRange = { warehouseId: '',  materialCategoryId:''}\r\n        this.lastCheckRange = Object.assign({}, this.checkRange);\r\n\r\n        //处理状态：编辑中\r\n        this.model.billProcStatus = '12'\r\n\r\n        // 请求后台的填值规则接口地址\r\n        const url = '/sys/fillRule/executeRuleByCode/'\r\n        const ruleCode = 'stock_check_bill_no'\r\n        const that = this\r\n        putAction(url + ruleCode, {}).then(res => {\r\n          // 执行成功，获取返回的值，并赋到页面上\r\n          if (res.success) {\r\n            that.model.billNo = res.result;\r\n            that.$nextTick(() => {\r\n              that.form.setFieldsValue({'billNo':res.result, 'billDate':getFormatDate()})\r\n            })\r\n          }\r\n        })\r\n      },\r\n      /** 调用完edit()方法之后会自动调用此方法 */\r\n      editAfter() {\r\n        let columns = this.stkCheckBillEntryTable.columns.filter(col => col.key === 'qty');\r\n        if (this.action === 'add') {\r\n          this.addInit();\r\n          columns[0].validateRules = [{}];\r\n        } else if (this.action === 'edit') {\r\n          columns[0].validateRules = [{ required: true, message: '${title}不能为空' }];\r\n        }\r\n\r\n        let fieldval = pick(this.model,'billNo','billDate','warehouseId','materialCategoryId','checkerId','attachment','remark','billProcStatus','approverId','flowId','isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime')\r\n        this.$nextTick(() => {\r\n          this.form.setFieldsValue(fieldval)\r\n        })\r\n        // 加载子表数据\r\n        if (this.model.id) {\r\n          const that = this;\r\n          let params = { id: this.model.id }\r\n          this.requestSubTableData(this.url.stkCheckBillEntry.list, params, this.stkCheckBillEntryTable, splitData)\r\n\r\n          function splitData(){\r\n            let dataSource = [], dataSourceNew = [];\r\n            for(let row of that.stkCheckBillEntryTable.dataSource) {\r\n              if (row.isNewBatch===0) {\r\n                dataSource.push(row);\r\n              } else {\r\n                dataSourceNew.push(row);\r\n              }\r\n            }\r\n            dataSource.sort((a, b) => a.entryNo - b.entryNo);\r\n            that.stkCheckBillEntryTable.dataSource = dataSource;\r\n            dataSourceNew.sort((a, b) => a.entryNo - b.entryNo);\r\n            that.stkCheckBillEntryTable.dataSourceNew = dataSourceNew;\r\n          }\r\n        }\r\n      },\r\n\r\n      /** 整理成formData */\r\n      classifyIntoFormData(allValues) {\r\n        let main = Object.assign(this.model, allValues.formValue)\r\n        return {\r\n          ...main, // 展开\r\n          stkCheckBillEntryList: allValues.tablesValue[0].values.concat(allValues.tablesValue[1].values),\r\n        }\r\n      },\r\n\r\n      validateError(msg){\r\n        this.$message.error(msg)\r\n      },\r\n\r\n      popupCallback(row){\r\n        this.form.setFieldsValue(pick(row,'billNo','billDate','warehouseId','materialCategoryId','checkerId','attachment','remark','billProcStatus','approverId','flowId','isApproved','effectiveTime','isVoided','isClosed','sysOrgCode','createBy','createTime','updateBy','updateTime'))\r\n      },\r\n\r\n      handleCheckRangeOk(){\r\n        this.requestSubTableData(this.url.stkCheckBillEntry.listByRange, this.checkRange, this.stkCheckBillEntryTable);\r\n        this.lastCheckRange = Object.assign({}, this.checkRange);\r\n      },\r\n\r\n      onInEntryAdded(event){\r\n        this.onEntryAdded(event);\r\n\r\n        const { row, target } = event\r\n        let { values } = target.getValuesSync({ validate: false, rowIds: [row.id] });\r\n        let batchNo =  this.model.billNo + \"-\" + values[0].entryNo;\r\n        target.setValues([{rowKey: row.id, values: {batchNo: batchNo, flag: \"1\"}}]);\r\n     },\r\n\r\n      onValueChange(event) {\r\n        const { type, row, column, value, target } = event\r\n\r\n        //flag: 是否自动设置的batchNo\r\n        if (row.flag == null || row.flag === \"\") {\r\n          target.setValues([{rowKey: row.id, values: {flag: \"0\"}}]);\r\n        }\r\n        if (column.key === \"entryNo\" && (row.flag === \"1\" || row.batchNo === \"\" || row.batchNo == null)) {\r\n          target.setValues([{rowKey: row.id, values: {batchNo: this.model.billNo + \"-\" + value, flag: \"1\"}}]);\r\n        }\r\n        else if (column.key === \"batchNo\") {\r\n          target.setValues([{rowKey: row.id, values: {flag: \"0\"}}]);\r\n        }\r\n\r\n        //qty 实存数量 --> profitQty 盈亏数量\r\n        if (column.key === 'qty') {\r\n          let qty = Number(value);\r\n          let bookQty = Number(row.bookQty);\r\n          if (!isNaN(qty) && !isNaN(bookQty)){\r\n            target.setValues([{rowKey: row.id, values: {profitQty:  qty - bookQty}}]);\r\n          }\r\n        }\r\n      },\r\n\r\n    }\r\n  }\r\n</script>\r\n\r\n<style lang=\"less\" scoped>\r\n  .ant-row.ant-form-item {\r\n    margin-bottom: 12px;\r\n  }\r\n</style>\r\n"]}]}